<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek RAG增强聊天</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .controls-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 85%;
            position: relative;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 4px;
            color: #444;
            font-size: 0.95rem;
        }

        .match-reason {
            margin-top: 2px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            background-color: #f8f8f8;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .message.user {
            align-self: flex-end;
            background-color: #e1f5fe;
            border: 1px solid #b3e5fc;
        }

        .message.user .message-sender {
            color: #0277bd;
        }

        .message.assistant {
            align-self: flex-start;
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
        }

        .message.assistant .message-sender {
            color: #616161;
        }

        .message.system {
            align-self: center;
            background-color: #fff3e0;
            border: 1px solid #ffe0b2;
            font-style: italic;
            max-width: 70%;
        }

        .message-content {
            word-break: break-word;
        }

        .thinking-section {
            border-left: 3px solid #673ab7;
            padding-left: 10px;
            margin-bottom: 15px;
        }

        .answer-section {
            border-left: 3px solid #4caf50;
            padding-left: 10px;
        }

        .section-title {
            font-weight: bold;
            color: #1976d2;
            margin: 5px 0;
        }

        .process-marker {
            color: #757575;
            font-style: italic;
            margin: 5px 0;
        }

        .input-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
            height: 80px;
            font-family: inherit;
            font-size: 14px;
        }

        .input-controls {
            display: flex;
            justify-content: space-between;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #send-button {
            background-color: #1976d2;
            color: white;
        }

        #send-button:hover {
            background-color: #1565c0;
        }

        #stop-btn {
            background-color: #f44336;
            color: white;
        }

        #stop-btn:hover {
            background-color: #d32f2f;
        }

        .references-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #ff9800;
        }

        .references-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #e65100;
        }

        .reference-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .reference-title {
            font-weight: bold;
        }

        .reference-content {
            margin: 5px 0;
            font-style: italic;
            color: #555;
        }

        .reference-meta {
            font-size: 12px;
            color: #757575;
        }

        .collapsible {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .toggle-icon {
            margin-left: auto;
        }

        .collapsible-content {
            padding: 10px;
            background-color: #fff;
        }

        .collapsible.collapsed .collapsible-content {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center;">
                <a href="/static/session_manager.html" class="back-link" style="font-size: 0.8em;">← 返回会话列表</a>
                <h1 style="font-size: 0.9em; margin-left: 10px;" id="session-title"></h1>
            </div>
        </header>
        <main>
            <div class="chat-container">
                <div class="messages-container" id="messages-container">
                </div>
                <div class="input-container">
                    <textarea id="user-input" placeholder="输入您的问题..." rows="3"></textarea>
                    <div class="input-controls">
                        <div>
                            <label style="display: flex; align-items: center; font-size: 12px; color: #666;">
                                <input type="checkbox" id="auto-role-match" style="margin-right: 5px;">
                                启用智能角色匹配
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="stop-btn" disabled
                                style="background-color: #f44336; color: white;">停止生成</button>
                            <button id="send-button">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-btn');

        // 全局变量
        let isWaitingForResponse = false;
        let currentMessages = [];
        let currentMessageId = null;
        let currentSessionId = null; // 存储当前会话ID
        let isLoadingHistory = false; // 标记是否正在加载历史消息
        let currentUserName = '用户'; // 当前用户名
        let currentUserId = null; // 存储用户ID
        let selectedRoleId = null; // 当前选中的角色ID
        let selectedRoleName = '助手'; // 当前选中的角色名称

        // 初始化参数
        function initializeParams() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL查询参数:', window.location.search);

            // 获取并保存会话ID
            currentSessionId = urlParams.get('session_id');

            // 获取并保存用户ID和用户名
            const userId = urlParams.get('userId');
            if (userId) {
                currentUserId = userId;
                console.log('已设置用户ID:', currentUserId);
            } else {
                currentUserId = 'anonymous_user';
                console.log('未找到用户ID参数，使用默认值:', currentUserId);
            }

            const userName = urlParams.get('userName');
            if (userName) {
                currentUserName = decodeURIComponent(userName);
                console.log('已设置用户名:', currentUserName);
            } else {
                currentUserName = '用户';
                console.log('未找到用户名参数，使用默认值:', currentUserName);
            }

            console.log('初始化参数完成:', {
                session_id: currentSessionId,
                userId: currentUserId,
                userName: currentUserName
            });

            return {
                sessionId: currentSessionId,
                userId: currentUserId,
                userName: currentUserName
            };
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 添加全局错误处理
            window.addEventListener('error', function (event) {
                console.error('全局错误:', event.error);
                alert(`发生错误: ${event.error?.message || '未知错误'}`);
            });

            // 初始化参数
            const params = initializeParams();

            // // 更新页面标题，显示完整会话ID和用户名
            if (params.sessionId) {
            //     // 尝试获取会话角色信息
            //     fetchSessionRoles(params.sessionId).then(roles => {
            //         if (roles && roles.length > 0) {
            //             // 获取第一个角色
            //             const firstRole = roles[0];
            //             selectedRoleId = firstRole.id;
            //             selectedRoleName = firstRole.name;
            //             console.log(`已从会话中获取角色: ${selectedRoleName} (${selectedRoleId})`);
                        
            //             // 更新页面标题
            //             updatePageWithRoleName(selectedRoleName);
            //         }
            //     }).catch(error => {
            //         console.warn('获取会话角色失败:', error);
            //     });
                
                let title = ``;
                // 显示完整会话ID
                title += `(会话: ${params.sessionId}) `;
                // 如果有用户名，显示用户名
                if (params.userName) {
                    title += `用户: ${params.userName}`;
                }
                // 更新页面标题
                updatePageWithRoleName(`${params.userName}`);
                document.getElementById('session-title').innerText = title;
                console.log(`已加载会话: ${params.sessionId}, 用户: ${params.userName}`);

                // 尝试加载历史消息
                loadSessionMessages(params.userId);
            } else {
                console.warn('未提供会话ID，将使用临时会话 - 这可能导致某些功能不可用');

                // 添加警告消息到UI
                const warningElement = document.createElement('div');
                warningElement.className = 'message system';
                warningElement.innerHTML = `
                    <div class="message-content" style="color: #e65100; background-color: #fff3e0; padding: 10px; border-radius: 5px;">
                        <strong>⚠️ 警告：</strong> 未提供会话ID参数，正在使用临时会话模式。
                        <br><br>
                        某些功能可能不可用。建议通过正确的方式访问，如：
                        <br>
                        <code style="background: #f5f5f5; padding: 3px 5px;">/static/rag-chat.html?session_id=您的会话ID</code>
                    </div>
                `;
                messagesContainer.appendChild(warningElement);

                // 初始系统消息
                currentMessages.push({
                    role: 'system',
                    content: `你是一个知识渊博、乐于助人的助手。`
                });
            }

            // 添加事件监听器
            sendButton.addEventListener('click', sendMessage);
            stopButton.addEventListener('click', stopGeneration);

            // 添加输入框回车事件
            userInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // 加载会话历史消息
        async function loadSessionMessages(userId) {
            if (!currentSessionId || isLoadingHistory) return;

            isLoadingHistory = true;
            console.log('开始加载历史消息, 会话ID:', currentSessionId);
            
            // 确保有用户ID - 优先使用传入的参数，然后是全局变量，最后是默认值
            const effectiveUserId = userId || currentUserId || 'anonymous_user';
            console.log('加载历史消息使用用户ID:', effectiveUserId);

            // 创建加载中元素并添加唯一ID以便后续引用
            const loadingElementId = `loading-indicator-${Date.now()}`;
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message system';
            loadingElement.id = loadingElementId;
            loadingElement.innerHTML = '<div class="message-content">加载历史消息中...</div>';
            messagesContainer.appendChild(loadingElement);

            try {
                // 调用API获取会话详情
                // console.log(`请求会话详情: /api/memory/session/${currentSessionId}`);
                // const sessionResponse = await fetch(`/api/memory/session/${currentSessionId}`);

                // if (!sessionResponse.ok) {
                //     throw new Error(`获取会话详情失败: ${sessionResponse.status}`);
                // }

                // const sessionData = await sessionResponse.json();

                // if (!sessionData.success || !sessionData.exists) {
                //     console.warn('会话不存在或数据加载失败，将继续获取消息');
                // }

                // 获取短期记忆消息 - 使用正确的API端点
                console.log(`请求会话消息: /api/memory/session/${currentSessionId}/messages`);
                let messagesResponse = await fetch(`/api/memory/session/${currentSessionId}`);

                if (!messagesResponse.ok) {
                    console.warn(`获取会话消息失败，尝试备用端点: ${messagesResponse.status}`);
                    // 尝试备用API端点
                    const fallbackResponse = await fetch(`/api/memory/session/${currentSessionId}/messages`);
                    if (!fallbackResponse.ok) {
                        throw new Error(`所有消息API端点都失败: ${fallbackResponse.status}`);
                    }
                    messagesResponse = fallbackResponse;
                }
                
                const messagesData = await messagesResponse.json();
                processMessages(messagesData.messages || []);

                // 安全地移除加载消息
                safeRemoveElement(loadingElementId);

                // 滚动到底部
                scrollToBottom();

            } catch (error) {
                console.error('加载历史消息失败:', error);

                // 安全地移除加载消息
                safeRemoveElement(loadingElementId);

                // 显示错误消息
                const errorElement = document.createElement('div');
                errorElement.className = 'message system';
                errorElement.innerHTML = `<div class="message-content">加载历史消息失败: ${error.message}</div>`;
                messagesContainer.appendChild(errorElement);

                // 添加系统消息到当前会话
                currentMessages.push({
                    role: 'system',
                    content: `你是一个知识渊博、乐于助人的助手。`
                });

            } finally {
                isLoadingHistory = false;
            }
        }

        // 添加一个安全移除元素的辅助函数
        function safeRemoveElement(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.parentNode) {
                try {
                    element.parentNode.removeChild(element);
                    console.log(`成功移除元素: ${elementId}`);
                } catch (e) {
                    console.warn(`移除元素 ${elementId} 时出错:`, e);
                }
            } else {
                console.log(`元素 ${elementId} 不存在或已被移除`);
            }
        }

        // 处理历史消息数据
        function processMessages(messages) {
            // 清空消息容器
            messagesContainer.innerHTML = '';

            // 重置当前消息数组
            currentMessages = [];

            // 添加系统消息
            currentMessages.push({
                role: 'system',
                content: `你是一个知识渊博、乐于助人的助手。`
            });
            
            // 检查消息中是否有角色信息
            if (messages && messages.length > 0) {
                // 尝试从历史消息中找到助手角色名称
                for (const msg of messages) {
                    if (msg.role === 'assistant' && msg.assistant_name) {
                        selectedRoleName = msg.assistant_name;
                        console.log(`从历史消息中获取到角色名称: ${selectedRoleName}`);
                        break;
                    }
                    // 检查元数据中的角色ID
                    if (msg.metadata && msg.metadata.role_id) {
                        selectedRoleId = msg.metadata.role_id;
                        console.log(`从历史消息中获取到角色ID: ${selectedRoleId}`);
                    }
                }
            }

            // 如果没有消息，直接返回
            if (!messages || messages.length === 0) {
                return;
            }

            // 按时间排序消息（确保最老的消息先显示）
            messages.sort((a, b) => {
                const timeA = new Date(a.timestamp || a.created_at || 0);
                const timeB = new Date(b.timestamp || b.created_at || 0);
                return timeA - timeB;
            });

            // 遍历消息并添加到UI
            messages.forEach(msg => {
                // 确定角色
                let role = msg.role || (msg.is_user ? 'user' : 'assistant');

                // 获取发送者名称（如果有的话）
                let senderName = null;
                if (role === 'user') {
                    // 尝试从消息中获取用户名
                    senderName = msg.user_name || msg.sender || currentUserName;
                } else if (role === 'assistant') {
                    senderName = msg.assistant_name || selectedRoleName;
                }

                // 创建消息元素
                const messageElement = document.createElement('div');
                messageElement.className = `message ${role}`;

                // 添加发送者名称（如果不是系统消息）
                if (role !== 'system' && senderName) {
                    const senderElement = document.createElement('div');
                    senderElement.className = 'message-sender';
                    senderElement.textContent = senderName;
                    messageElement.appendChild(senderElement);
                }

                // 添加消息内容
                const contentElement = document.createElement('div');
                contentElement.className = 'message-content';

                if (role === 'assistant') {
                    contentElement.innerHTML = formatAssistantContent(msg.content);
                } else {
                    contentElement.textContent = msg.content;
                }

                messageElement.appendChild(contentElement);
                messagesContainer.appendChild(messageElement);

                // 添加到当前消息数组（用于API调用）
                if (role !== 'system') {
                    currentMessages.push({
                        role: role,
                        content: msg.content
                    });
                }
            });

            // 滚动到底部
            scrollToBottom();
        }

        // 发送消息
        async function sendMessage() {
            const userMessage = userInput.value.trim();

            if (!userMessage || isWaitingForResponse) return;

            // 添加用户消息到UI
            addMessageToUI('user', userMessage);

            // 添加到消息历史
            currentMessages.push({
                role: 'user',
                content: userMessage
            });

            // 清空输入框并更新状态
            userInput.value = '';
            isWaitingForResponse = true;
            sendButton.disabled = true;

            // 添加助手响应框
            const assistantMessageElement = addMessageToUI('assistant', '', selectedRoleName);
            console.log('创建助手消息元素:', assistantMessageElement);

            try {
                // 获取URL参数中的用户ID
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');

                // 生成消息ID
                currentMessageId = Date.now().toString(36) + Math.random().toString(36).substring(2, 9);

                // 准备请求参数
                const requestData = {
                    messages: currentMessages,
                    stream: false,  // 改为false，让后端决定使用何种方式响应
                    temperature: 0.7,
                    role_id: selectedRoleId,
                    message_id: currentMessageId,
                    // 添加自动角色匹配参数
                    auto_role_match: document.getElementById('auto-role-match')?.checked || false,
                    // 添加必需参数
                    provider: "deepseek",
                    model_name: "deepseek-chat",
                    api_key: ""  // 使用空字符串
                };

                // 如果有会话ID，添加到请求参数中
                if (currentSessionId) {
                    requestData.session_id = currentSessionId;
                    console.log('使用会话ID:', currentSessionId);
                } else {
                    console.warn('没有会话ID，服务器将创建临时会话 - 可能无法保存聊天记录');
                    // 添加提示内容到助手消息中
                    const contentElement = assistantMessageElement.querySelector('.message-content');
                    if (contentElement) {
                        contentElement.innerHTML = `<div style="color: #e65100; padding: 5px; margin-bottom: 10px; font-style: italic; background-color: #fff3e0; border-radius: 5px;">
                            正在临时会话模式下处理请求，消息可能无法被正确存储...
                        </div>`;
                    }
                }

                // 如果有用户ID，添加到请求参数中 - 使用全局变量
                if (currentUserId) {
                    requestData.user_id = currentUserId;
                    console.log('使用已保存的用户ID:', currentUserId);
                } else if (userId) {
                    // 备用：如果全局变量为空，尝试从URL获取
                    requestData.user_id = userId;
                    console.log('从URL获取用户ID:', userId);
                } else {
                    // 默认值
                    requestData.user_id = 'anonymous_user';
                    console.log('使用默认用户ID: anonymous_user');
                }
                
                // 调用聊天API
                console.log('发送聊天请求:', JSON.stringify(requestData, null, 2));
                console.log('使用端点: /api/llm/chatrag');
                
                // 确保任何现有的reader已被关闭
                if (window.currentReader) {
                    try {
                        console.log('关闭之前的流读取器');
                        window.currentReader.cancel().catch(e => console.warn('取消之前的reader失败:', e));
                        window.currentReader = null;
                    } catch (e) {
                        console.warn('关闭之前的reader失败:', e);
                    }
                }
                
                const response = await fetch('/api/llm/chatrag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                // 记录响应头信息以便调试
                console.log('响应状态:', response.status);
                console.log('响应类型:', response.headers.get('Content-Type'));
                const contentType = response.headers.get('Content-Type') || '';
                const isStreamResponse = contentType.includes('text/event-stream');
                console.log('是否为流式响应:', isStreamResponse);

                // 处理错误响应
                if (!response.ok) {
                    // 尝试获取错误详情
                    let errorDetail = '';
                    try {
                        const errorJson = await response.json();
                        if (typeof errorJson === 'object') {
                            // 将对象转换为格式化的字符串
                            errorDetail = JSON.stringify(errorJson, null, 2);
                        } else {
                            errorDetail = errorJson.error || errorJson.detail || JSON.stringify(errorJson);
                        }
                    } catch (e) {
                        // 如果无法解析JSON，则使用响应文本
                        errorDetail = await response.text();
                    }
                    
                    console.error('API返回错误:', errorDetail);
                    
                    // 抛出更详细的错误
                    throw new Error(`API错误: ${response.status}${errorDetail ? ' - ' + errorDetail : ''}`);
                }

                // 对于非流式响应，直接处理JSON
                if (!isStreamResponse && contentType.includes('application/json')) {
                    console.log('接收到JSON响应，直接处理');
                    try {
                        const jsonData = await response.json();
                        console.log('JSON响应内容:', jsonData);
                        
                        // 处理不同类型的JSON响应结构
                        let responseContent = null;
                        
                        // 1. 处理OpenAI风格响应
                        if (jsonData.choices && jsonData.choices.length > 0) {
                            if (jsonData.choices[0].message && jsonData.choices[0].message.content) {
                                responseContent = jsonData.choices[0].message.content;
                            }
                        }
                        // 2. 处理直接内容响应
                        else if (jsonData.content) {
                            responseContent = jsonData.content;
                        }
                        // 3. 处理RAG特定响应
                        else if (jsonData.response && jsonData.response.content) {
                            responseContent = jsonData.response.content;
                        }
                        
                        // 如果成功提取到内容
                        if (responseContent) {
                            // 更新UI中的消息
                            updateAssistantMessage(assistantMessageElement, responseContent);
                            
                            // 添加到消息历史
                            currentMessages.push({
                                role: 'assistant',
                                content: responseContent
                            });
                            
                            // 处理角色信息（如果有）
                            if (jsonData.role_match || jsonData.role_info) {
                                const roleInfo = jsonData.role_match?.role || jsonData.role_info;
                                if (roleInfo && roleInfo.name) {
                                    console.log('从响应中获取角色信息:', roleInfo);
                                    
                                    // 更新UI中的角色名称
                                    const senderElement = assistantMessageElement.querySelector('.message-sender');
                                    if (senderElement) {
                                        senderElement.textContent = roleInfo.name;
                                    }
                                }
                            }
                            
                            console.log('成功处理非流式响应');
                            
                            // 重置状态
                            isWaitingForResponse = false;
                            sendButton.disabled = false;
                            stopButton.disabled = true;
                            
                            // 滚动到底部
                            scrollToBottom();
                            return;
                        } else {
                            console.warn('无法从JSON响应提取内容:', jsonData);
                        }
                    } catch (e) {
                        console.error('解析JSON响应出错:', e);
                    }
                }

                // 如果不是JSON响应或无法提取内容，尝试流式处理
                if (response.body) {
                    // 启用停止按钮（对于流式响应）
                    stopButton.disabled = false;
                    
                    let reader = null;
                    try {
                        // 检查stream是否已锁定
                        if (response.body.locked) {
                            console.warn('响应流已被锁定，尝试使用备用方法获取数据');
                            try {
                                // 备用方法：尝试使用克隆的响应来获取内容
                                const clonedResponse = response.clone();
                                const textContent = await clonedResponse.text();
                                console.log('使用备用方法获取到内容:', textContent.substring(0, 100) + '...');
                                
                                try {
                                    // 尝试解析JSON
                                    const jsonData = JSON.parse(textContent);
                                    // 提取内容和角色信息
                                    if (jsonData.choices && jsonData.choices.length > 0) {
                                        if (jsonData.choices[0].message && jsonData.choices[0].message.content) {
                                            updateAssistantMessage(assistantMessageElement, jsonData.choices[0].message.content);
                                            currentMessages.push({
                                                role: 'assistant',
                                                content: jsonData.choices[0].message.content
                                            });
                                        }
                                    }
                                    // 检查角色信息
                                    if (jsonData.role_match && jsonData.role_match.role) {
                                        const roleInfo = jsonData.role_match.role;
                                        // 更新全局变量
                                        if (roleInfo.name) {
                                            selectedRoleName = roleInfo.name;
                                            console.log('备用方法更新全局角色名称为:', selectedRoleName);
                                            
                                            // 更新页面标题显示角色名
                                            updatePageWithRoleName(selectedRoleName);
                                        }
                                        updateAssistantRoleInfo(assistantMessageElement, roleInfo);
                                    }
                                } catch (jsonError) {
                                    console.error('解析备用内容失败:', jsonError);
                                    updateAssistantMessage(assistantMessageElement, '无法获取响应内容，请重试。');
                                }
                            } catch (backupError) {
                                console.error('备用方法失败:', backupError);
                                const contentElement = assistantMessageElement.querySelector('.message-content');
                                if (contentElement) {
                                    contentElement.innerHTML = `<div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                                        <strong>错误:</strong> 响应流已被锁定，无法处理。请重新发送消息。
                                    </div>`;
                                }
                            }
                            
                            isWaitingForResponse = false;
                            sendButton.disabled = false;
                            stopButton.disabled = true;
                            return;
                        }
                        
                        // 获取reader并存储在全局变量中方便后续清理
                        reader = response.body.getReader();
                        window.currentReader = reader;
                    } catch (readerError) {
                        console.error('获取流读取器失败:', readerError);
                        const contentElement = assistantMessageElement.querySelector('.message-content');
                        if (contentElement) {
                            contentElement.innerHTML += `<div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                                <strong>错误:</strong> 无法获取响应流 (${readerError.message})
                            </div>`;
                        }
                        isWaitingForResponse = false;
                        sendButton.disabled = false;
                        stopButton.disabled = true;
                        return;
                    }
                    
                    const decoder = new TextDecoder();
                    let responseText = '';
                    let references = null;
                    let startTime = Date.now();
                    let hasReceivedContent = false; // 标记是否接收到内容

                    // 处理流式响应
                    try {
                        console.log('开始处理响应流');
                        while (true) {
                            let readResult;
                            try {
                                readResult = await reader.read();
                            } catch (readError) {
                                console.error('读取流失败:', readError);
                                break;
                            }
                            
                            const { value, done } = readResult;
                            
                            if (done) {
                                console.log('响应流结束 - done标志');
                                break;
                            }

                            const chunk = decoder.decode(value, { stream: true });
                            console.log('接收到数据块:', chunk.length, '字节');
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                // 忽略空行或只包含HTTP头信息的行
                                if (!line.trim() || line.trim().startsWith(':') || line.includes('keep-alive')) {
                                    console.log('忽略HTTP头或空行:', line);
                                    continue;
                                }
                                
                                if (line.startsWith('data: ') && line.length > 6) {
                                    const data = line.substring(6).trim();
                                    console.log('处理SSE数据行:', data.substring(0, 50) + (data.length > 50 ? '...' : ''));

                                    // 检查是否为结束标记
                                    if (data === '[DONE]') {
                                        isWaitingForResponse = false;
                                        sendButton.disabled = false;
                                        stopButton.disabled = true;
                                        break;
                                    }

                                    try {
                                        // 解析 JSON 数据
                                        let parsedData = JSON.parse(data);
                                        
                                        // 检查是否有错误
                                        if (parsedData.error) {
                                            console.error('API错误:', parsedData.error);
                                            const contentElement = assistantMessageElement.querySelector('.message-content');
                                            if (contentElement) {
                                                const errorMsg = `<div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                                                    <strong>错误:</strong> ${parsedData.error}
                                                </div>`;
                                                contentElement.innerHTML += errorMsg;
                                            }
                                            continue;
                                        }
                                        
                                        // 处理消息ID
                                        if (parsedData.message_id) {
                                            console.log('收到消息ID:', parsedData.message_id);
                                            currentMessageId = parsedData.message_id;
                                            stopButton.disabled = false;
                                            continue;
                                        }
                                        
                                        // 处理角色匹配结果
                                        if (parsedData.role_match) {
                                            console.log('角色匹配结果:', parsedData.role_match);
                                            const roleMatch = parsedData.role_match;
                                            
                                            if (roleMatch.success && roleMatch.role) {
                                                // 更新全局变量，保存匹配的角色名称
                                                if (roleMatch.role.name) {
                                                    selectedRoleName = roleMatch.role.name;
                                                    console.log('更新全局角色名称为:', selectedRoleName);
                                                    
                                                    // 更新页面标题显示角色名
                                                    updatePageWithRoleName(selectedRoleName);
                                                }
                                                // 调用新函数处理角色信息
                                                updateAssistantRoleInfo(assistantMessageElement, roleMatch.role);
                                            }
                                            continue;
                                        }
                                        
                                        // 处理常规SSE流式响应 (api/llm/chat格式)
                                        if (parsedData.event_type === 'content') {
                                            if (parsedData.text) {
                                                responseText += parsedData.text;
                                                updateAssistantMessage(assistantMessageElement, responseText);
                                            }
                                        }
                                        // 处理RAG格式响应 (api/llm/chatrag格式)
                                        else if (parsedData.choices && Array.isArray(parsedData.choices)) {
                                            // 处理不同类型的RAG响应
                                            if (parsedData.choices[0].delta && parsedData.choices[0].delta.content) {
                                                // 流式增量格式
                                                responseText += parsedData.choices[0].delta.content;
                                                updateAssistantMessage(assistantMessageElement, responseText);
                                            }
                                            else if (parsedData.choices[0].message && parsedData.choices[0].message.content) {
                                                // 完整消息格式
                                                responseText = parsedData.choices[0].message.content;
                                                updateAssistantMessage(assistantMessageElement, responseText);
                                                
                                                // 这是完整响应，可以退出处理循环
                                                isWaitingForResponse = false;
                                                sendButton.disabled = false;
                                                stopButton.disabled = true;
                                                break;
                                            }
                                            else if (parsedData.choices[0].delta && parsedData.choices[0].delta.role === 'assistant') {
                                                // 角色声明，忽略但记录
                                                console.log('收到角色声明:', parsedData.choices[0].delta.role);
                                            }
                                            else if (parsedData.choices[0].finish_reason) {
                                                // 结束标记
                                                console.log('收到结束标记:', parsedData.choices[0].finish_reason);
                                                isWaitingForResponse = false;
                                                sendButton.disabled = false;
                                                stopButton.disabled = true;
                                                break;
                                            }
                                        }
                                        // 处理引用信息
                                        else if (parsedData.event_type === 'references' && parsedData.references) {
                                            references = parsedData.references;
                                        }
                                        // 处理开始事件
                                        else if (parsedData.event_type === 'start') {
                                            console.log('开始生成响应', parsedData);
                                            startTime = Date.now();
                                        }
                                        // 处理结束事件
                                        else if (parsedData.event_type === 'end') {
                                            console.log('生成响应完成', parsedData);
                                            const endTime = Date.now();
                                            console.log(`生成耗时: ${(endTime - startTime) / 1000}秒`);
                                        }
                                        // 处理停止事件
                                        else if (parsedData.event_type === 'stopped') {
                                            console.log('生成已手动停止', parsedData);
                                            const contentElement = assistantMessageElement.querySelector('.message-content');
                                            if (contentElement) {
                                                const stoppedMsg = `<div style="color: #666; font-style: italic; margin-top: 8px; padding: 5px;">
                                                    消息生成已停止
                                                </div>`;
                                                contentElement.innerHTML += stoppedMsg;
                                            }
                                        }
                                        // 处理其他未知事件类型
                                        else {
                                            console.log('收到未知格式数据:', parsedData);
                                        }
                                    } catch (e) {
                                        console.warn('解析响应数据失败:', e, data);
                                    }
                                } else if (line.trim() && line.trim() !== 'data:') {
                                    // 处理非标准格式的数据行
                                    console.log('收到非标准数据行:', line);
                                    try {
                                        // 尝试直接解析JSON (非SSE格式)
                                        const parsedData = JSON.parse(line);
                                        console.log('解析非SSE格式JSON成功:', parsedData);
                                        
                                        // 处理RAG直接响应格式
                                        if (parsedData.choices && parsedData.choices[0] && parsedData.choices[0].message) {
                                            responseText = parsedData.choices[0].message.content;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                            isWaitingForResponse = false;
                                            sendButton.disabled = false;
                                            stopButton.disabled = true;
                                        }
                                    } catch (e) {
                                        console.warn('尝试解析非标准数据行失败:', e);
                                    }
                                }
                            }
                        }

                        // 添加引用信息（如果有）
                        if (references) {
                            showReferences(references, assistantMessageElement);
                        }

                        // 添加到消息历史
                        if (responseText) {
                            currentMessages.push({
                                role: 'assistant',
                                content: responseText
                            });
                        }
                    } catch (e) {
                        console.error('解析流式响应失败:', e);
                    } finally {
                        // 在finally语句中确保释放reader
                        try {
                            if (reader) {
                                try {
                                    // 尝试取消读取
                                    reader.cancel().catch(e => console.warn('取消reader失败:', e));
                                    // 清除全局引用
                                    if (window.currentReader === reader) {
                                        window.currentReader = null;
                                    }
                                } catch (cancelError) {
                                    console.warn('取消reader失败:', cancelError);
                                }
                            }
                        } catch (e) {
                            console.warn('关闭reader失败:', e);
                        }
                        
                        // 重置UI状态
                        isWaitingForResponse = false;
                        sendButton.disabled = false;
                        stopButton.disabled = true;
                    }
                } else {
                    console.error('响应没有body属性');
                    
                    // 如果响应没有body但状态是200，尝试直接获取响应内容
                    if (response.status === 200) {
                        try {
                            console.log('尝试直接读取响应JSON');
                            const jsonResponse = await response.json();
                            console.log('接收到完整JSON响应:', jsonResponse);
                            
                            // 处理非流式响应
                            if (jsonResponse.choices && jsonResponse.choices.length > 0) {
                                if (jsonResponse.choices[0].message && jsonResponse.choices[0].message.content) {
                                    responseText = jsonResponse.choices[0].message.content;
                                    updateAssistantMessage(assistantMessageElement, responseText);
                                    
                                    // 添加到消息历史
                                    currentMessages.push({
                                        role: 'assistant',
                                        content: responseText
                                    });
                                    
                                    console.log('成功处理非流式RAG响应');
                                }
                                
                                // 处理角色信息（如果有）
                                if (jsonResponse.role_match || jsonResponse.role_info) {
                                    const roleInfo = jsonResponse.role_match?.role || jsonResponse.role_info;
                                    if (roleInfo && roleInfo.name) {
                                        console.log('从响应中获取角色信息:', roleInfo);
                                        
                                        // 更新UI中的角色名称
                                        const senderElement = assistantMessageElement.querySelector('.message-sender');
                                        if (senderElement) {
                                            senderElement.textContent = roleInfo.name;
                                        }
                                    }
                                }
                            } else {
                                console.warn('响应没有预期的choices结构:', jsonResponse);
                            }
                        } catch (e) {
                            console.error('解析非流式响应失败:', e);
                            throw new Error('无法解析响应: ' + e.message);
                        }
                    } else {
                        throw new Error('无效的流式响应');
                    }
                }

                // 重置状态
                isWaitingForResponse = false;
                sendButton.disabled = false;
                stopButton.disabled = true;

                // 滚动到底部
                scrollToBottom();

            } catch (error) {
                console.error('发送消息失败:', error);
                // 在UI中显示详细错误信息
                const contentElement = assistantMessageElement.querySelector('.message-content');
                if (contentElement) {
                    contentElement.innerHTML = `
                        <div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                            <strong>发送消息失败:</strong> ${error.message}
                            <br><br>
                            <details>
                                <summary>查看详细错误信息</summary>
                                <pre style="background: #f5f5f5; padding: 8px; overflow: auto;">${error.stack || '没有更多信息'}</pre>
                            </details>
                            <div style="margin-top: 8px;">请刷新页面或返回会话列表重试。</div>
                        </div>
                    `;
                }

                // 重置状态
                isWaitingForResponse = false;
                sendButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        // 停止生成
        async function stopGeneration() {
            if (!currentMessageId) {
                console.log('没有当前消息ID，无法停止生成');
                return;
            }

            try {
                console.log('停止生成消息:', currentMessageId);

                const requestData = {
                    message_id: currentMessageId
                };

                const response = await fetch('/api/llm/chatrag/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API错误: ${response.status}`);
                }

                // 禁用停止按钮
                stopButton.disabled = true;
            } catch (error) {
                console.error('停止生成失败:', error);
            }
        }

        // 添加消息到UI
        function addMessageToUI(role, content, senderName = null) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}`;
            
            // 添加发送者名称
            if (role !== 'system') {
                const senderElement = document.createElement('div');
                senderElement.className = 'message-sender';
                
                if (role === 'user') {
                    senderElement.textContent = currentUserName || '用户';
                } else {
                    senderElement.textContent = senderName || selectedRoleName || '助手';
                }
                
                messageElement.appendChild(senderElement);
            }
            
            // 添加消息内容
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            
            if (role === 'assistant') {
                contentElement.innerHTML = formatAssistantContent(content);
            } else {
                contentElement.textContent = content;
            }
            
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);
            
            // 滚动到底部
            scrollToBottom();
            
            return messageElement;
        }

        // 更新助手消息内容
        function updateAssistantMessage(element, content) {
            const contentElement = element.querySelector('.message-content');
            if (!contentElement) {
                console.error('找不到消息内容元素:', element);
                return;
            }

            console.log('更新消息内容:', content.substring(0, 50) + (content.length > 50 ? '...' : ''));
            contentElement.innerHTML = formatAssistantContent(content);

            // 滚动到底部
            scrollToBottom();
        }

        // 格式化助手内容（支持基本Markdown）
        function formatAssistantContent(content) {
            if (!content) return '';

            // 转义HTML
            let formatted = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // 简单的Markdown支持
            // 代码块 ```code```
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // 行内代码 `code`
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // 粗体 **text**
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 斜体 *text*
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 换行
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // 显示引用信息
        function showReferences(references, messageElement) {
            // 创建引用容器
            const referencesContainer = document.createElement('div');
            referencesContainer.className = 'references-container';

            // 添加标题
            const headerElement = document.createElement('div');
            headerElement.className = 'references-header';
            headerElement.textContent = '参考资料';
            referencesContainer.appendChild(headerElement);

            // 添加引用列表
            references.forEach((ref, index) => {
                const refElement = document.createElement('div');
                refElement.className = 'reference-item';

                // 添加标题
                const titleElement = document.createElement('div');
                titleElement.className = 'reference-title';
                titleElement.textContent = `[${index + 1}] ${ref.title || '未知来源'}`;
                refElement.appendChild(titleElement);

                // 添加内容
                const contentElement = document.createElement('div');
                contentElement.className = 'reference-content';
                contentElement.textContent = ref.content || ref.text || '';
                refElement.appendChild(contentElement);

                referencesContainer.appendChild(refElement);
            });

            // 添加到消息元素
            messageElement.appendChild(referencesContainer);

            // 滚动到底部
            scrollToBottom();
        }

        // 滚动到底部
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 处理流式输出
        async function processStreamResponse(response, messageElement) {
            let reader = null;
            let receivedText = '';
            let contentElem = messageElement.querySelector('.message-content .text');
            let messageModel = messageElement.getAttribute('data-model') || '';
            let messageId = messageElement.getAttribute('data-message-id');
            
            try {
                // 安全获取reader，如果已锁定则会抛出异常
                reader = response.body.getReader();
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            // 流结束时，更新UI
                            contentElem.innerHTML = marked.parse(receivedText);
                            highlightCode(contentElem);
                            break;
                        }
                        
                        // 解码并处理接收到的数据
                        const chunks = new TextDecoder().decode(value).split('\n');
                        for (const chunk of chunks) {
                            if (!chunk.trim()) continue;
                            
                            try {
                                const data = JSON.parse(chunk);
                                receivedText = data.text || receivedText;
                                
                                // 更新消息内容
                                contentElem.innerHTML = marked.parse(receivedText);
                                highlightCode(contentElem);
                                
                                // 如果完成或出错，更新UI状态
                                if (data.status === 'completed' || data.status === 'error') {
                                    receivedText = data.text || receivedText;
                                    contentElem.innerHTML = marked.parse(receivedText);
                                    highlightCode(contentElem);
                                    
                                    if (data.status === 'error') {
                                        messageElement.classList.add('error');
                                    }
                                    break;
                                }
                            } catch (e) {
                                console.error('解析数据时出错:', e);
                            }
                        }
                    }
                } catch (readError) {
                    console.error('读取流时出错:', readError);
                    contentElem.textContent = `读取回复时出错: ${readError.message}`;
                    messageElement.classList.add('error');
                }
            } catch (lockError) {
                console.error('获取读取器时出错:', lockError);
                contentElem.textContent = `获取回复流时出错: ${lockError.message}`;
                messageElement.classList.add('error');
            } finally {
                // 尝试关闭reader（如果存在）
                if (reader) {
                    try {
                        await reader.cancel();
                    } catch (cancelError) {
                        console.error('取消读取器时出错:', cancelError);
                    }
                }
                
                // 重置UI状态
                enableInput();
            }
        }

        // 更新辅助函数
        
        // 添加处理角色信息的函数
        function updateAssistantRoleInfo(messageElement, roleInfo) {
            if (!messageElement || !roleInfo) return;
            
            console.log('更新角色信息:', roleInfo);
            
            // 更新全局变量
            if (roleInfo.name) {
                selectedRoleName = roleInfo.name;
            }
            
            // 更新角色名称
            const senderElement = messageElement.querySelector('.message-sender');
            if (senderElement) {
                const roleName = roleInfo.name || selectedRoleName || '助手';
                senderElement.textContent = roleName;
            } else {
                // 如果没有发送者元素，创建一个
                const newSenderElement = document.createElement('div');
                newSenderElement.className = 'message-sender';
                newSenderElement.textContent = roleInfo.name || selectedRoleName || '助手';
                messageElement.insertBefore(newSenderElement, messageElement.firstChild);
            }
            
            // 检查是否已经有匹配原因元素
            const existingReasonElement = messageElement.querySelector('.match-reason');
            
            // 如果有匹配原因且尚未显示，添加它
            if (roleInfo.match_reason && !existingReasonElement) {
                const contentElement = messageElement.querySelector('.message-content');
                if (contentElement) {
                    const matchReasonElement = document.createElement('div');
                    matchReasonElement.className = 'match-reason';
                    matchReasonElement.style.fontSize = '0.85em';
                    matchReasonElement.style.color = '#666';
                    matchReasonElement.style.fontStyle = 'italic';
                    matchReasonElement.style.marginBottom = '5px';
                    matchReasonElement.innerHTML = `匹配原因: ${roleInfo.match_reason}`;
                    messageElement.insertBefore(matchReasonElement, contentElement);
                }
            }
        }

        // 处理角色匹配相关的函数
        function updateSelectedRole(roleId, roleName) {
            selectedRoleId = roleId;
            if (roleName) {
                selectedRoleName = roleName;
                console.log(`已更新选中角色: ${roleName} (${roleId})`);
                // 更新页面标题或其他UI元素，显示已选择的角色
                const sessionTitle = document.getElementById('session-title');
                if (sessionTitle) {
                    sessionTitle.textContent = `会话 - ${roleName}`;
                }
            }
        }

        // 使用角色名称更新页面UI元素
        function updatePageWithRoleName(roleName) {
            if (!roleName) return;
            
            console.log(`更新页面显示角色名: ${roleName}`);
            
            // 更新页面标题
            const sessionTitle = document.getElementById('session-title');
            if (sessionTitle) {
                // 保留会话ID部分
                let existingTitle = sessionTitle.textContent || '';
                if (existingTitle.includes('(会话:')) {
                    // 提取会话ID部分
                    const sessionPart = existingTitle.match(/\(会话:.*?\)/);
                    if (sessionPart) {
                        sessionTitle.textContent = `${sessionPart[0]} 角色: ${roleName}`;
                    } else {
                        sessionTitle.textContent = `${existingTitle} - ${roleName}`;
                    }
                } else {
                    sessionTitle.textContent = `${existingTitle} - ${roleName}`;
                }
            }
            
            // 更新页面顶部可能显示的角色名
            document.querySelectorAll('.response-sender, .ai-name').forEach(elem => {
                if (elem.textContent.includes('智能助手') || elem.textContent === '助手') {
                    elem.textContent = roleName;
                }
            });
            
            // 添加一个辅助元素在页面头部显示角色名
            const headerElem = document.querySelector('header');
            if (headerElem) {
                if (!document.querySelector('.current-role-display')) {
                    const roleDisplay = document.createElement('div');
                    roleDisplay.className = 'current-role-display';
                    roleDisplay.style.fontSize = '0.85rem';
                    roleDisplay.style.color = '#555';
                    roleDisplay.style.marginTop = '5px';
                    roleDisplay.innerHTML = `当前角色: <span class="current-role-name">${roleName}</span>`;
                    headerElem.appendChild(roleDisplay);
                } else {
                    const roleNameElem = document.querySelector('.current-role-name');
                    if (roleNameElem) {
                        roleNameElem.textContent = roleName;
                    }
                }
            }
            
            // 更新现有的所有助手消息的发送者名称
            document.querySelectorAll('.message.assistant .message-sender').forEach(sender => {
                sender.textContent = roleName;
            });
            
            console.log(`页面UI已更新为角色名称: ${roleName}`);
        }

        // 从服务器获取会话角色信息
        // async function fetchSessionRoles(sessionId) {
        //     try {
        //         // 尝试从会话服务获取角色信息
        //         console.log(`获取会话 ${sessionId} 的角色信息`);
        //         const response = await fetch(`/api/sessions/${sessionId}/roles`);
                
        //         if (!response.ok) {
        //             console.warn(`获取会话角色失败: ${response.status}`);
        //             return null;
        //         }
                
        //         const rolesData = await response.json();
        //         console.log('获取到会话角色信息:', rolesData);
                
        //         return rolesData.map(role => ({
        //             id: role._id || role.id,
        //             name: role.name,
        //             description: role.description
        //         }));
                
        //     } catch (error) {
        //         console.error('获取会话角色出错:', error);
        //         return null;
        //     }
        // }
    </script>
</body>

</html>