<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek RAG增强聊天</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .controls-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 85%;
            position: relative;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 4px;
            color: #444;
            font-size: 0.95rem;
        }

        .match-reason {
            margin-top: 2px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            background-color: #f8f8f8;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .message.user {
            align-self: flex-end;
            background-color: #e1f5fe;
            border: 1px solid #b3e5fc;
        }

        .message.user .message-sender {
            color: #0277bd;
        }

        .message.assistant {
            align-self: flex-start;
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
        }

        .message.assistant .message-sender {
            color: #616161;
        }

        .message.system {
            align-self: center;
            background-color: #fff3e0;
            border: 1px solid #ffe0b2;
            font-style: italic;
            max-width: 70%;
        }

        .message-content {
            word-break: break-word;
        }

        .thinking-section {
            border-left: 3px solid #673ab7;
            padding-left: 10px;
            margin-bottom: 15px;
        }

        .answer-section {
            border-left: 3px solid #4caf50;
            padding-left: 10px;
        }

        .section-title {
            font-weight: bold;
            color: #1976d2;
            margin: 5px 0;
        }

        .process-marker {
            color: #757575;
            font-style: italic;
            margin: 5px 0;
        }

        .input-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
            height: 80px;
            font-family: inherit;
            font-size: 14px;
        }

        .input-controls {
            display: flex;
            justify-content: space-between;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #send-button {
            background-color: #1976d2;
            color: white;
        }

        #send-button:hover {
            background-color: #1565c0;
        }

        #stop-btn {
            background-color: #f44336;
            color: white;
        }

        #stop-btn:hover {
            background-color: #d32f2f;
        }

        .references-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #ff9800;
        }

        .references-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #e65100;
        }

        .reference-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .reference-title {
            font-weight: bold;
        }

        .reference-content {
            margin: 5px 0;
            font-style: italic;
            color: #555;
        }

        .reference-meta {
            font-size: 12px;
            color: #757575;
        }

        .collapsible {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .toggle-icon {
            margin-left: auto;
        }

        .collapsible-content {
            padding: 10px;
            background-color: #fff;
        }

        .collapsible.collapsed .collapsible-content {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center;">
                <a href="/static/session_manager.html" class="back-link" style="font-size: 0.8em;">← 返回会话列表</a>
                <h1 style="font-size: 0.9em; margin-left: 10px;" id="session-title"></h1>
            </div>
        </header>
        <main>
            <div class="chat-container">
                <div class="messages-container" id="messages-container">
                </div>
                <div class="input-container">
                    <textarea id="user-input" placeholder="输入您的问题..." rows="3"></textarea>
                    <div class="input-controls">
                        <div>
                            <label style="display: flex; align-items: center; font-size: 12px; color: #666;">
                                <input type="checkbox" id="auto-role-match" style="margin-right: 5px;">
                                启用智能角色匹配
                            </label>
                        </div>
                        <div class="secondary-controls">
                            <button id="clear-button" title="清空对话">清空对话</button>
                            <button id="reset-lock-button" title="重置会话锁" style="display:none; background-color: #FFA726; color: white;">重置会话锁</button>
                        </div>
                        <div class="primary-controls">
                            <button id="stop-btn" disabled>停止生成</button>
                            <button id="send-button">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-btn');
        const clearButton = document.getElementById('clear-button');
        const resetLockButton = document.getElementById('reset-lock-button');

        // 全局变量
        let isWaitingForResponse = false;
        let currentMessages = [];
        let currentMessageId = null;
        let currentSessionId = null; // 存储当前会话ID
        let isLoadingHistory = false; // 标记是否正在加载历史消息
        let currentUserName = '用户'; // 当前用户名
        let currentUserId = null; // 存储用户ID
        let selectedRoleId = null; // 当前选中的角色ID
        let selectedRoleName = '助手'; // 当前选中的角色名称
        let startTime = 0;
        let queryLang = 'zh';
        let references = null;

        // 初始化参数
        function initializeParams() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL查询参数:', window.location.search);

            // 获取并保存会话ID
            currentSessionId = urlParams.get('session_id');

            // 获取并保存用户ID和用户名
            const userId = urlParams.get('userId');
            if (userId) {
                currentUserId = userId;
                console.log('已设置用户ID:', currentUserId);
            } else {
                currentUserId = 'anonymous_user';
                console.log('未找到用户ID参数，使用默认值:', currentUserId);
            }

            const userName = urlParams.get('userName');
            if (userName) {
                currentUserName = decodeURIComponent(userName);
                console.log('已设置用户名:', currentUserName);
            } else {
                currentUserName = '用户';
                console.log('未找到用户名参数，使用默认值:', currentUserName);
            }

            console.log('初始化参数完成:', {
                session_id: currentSessionId,
                userId: currentUserId,
                userName: currentUserName
            });

            return {
                sessionId: currentSessionId,
                userId: currentUserId,
                userName: currentUserName
            };
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 添加全局错误处理
            window.addEventListener('error', function (event) {
                console.error('全局错误:', event.error);
                alert(`发生错误: ${event.error?.message || '未知错误'}`);
            });

            // 初始化参数
            const params = initializeParams();

            // // 更新页面标题，显示完整会话ID和用户名
            if (params.sessionId) {
            //     // 尝试获取会话角色信息
            //     fetchSessionRoles(params.sessionId).then(roles => {
            //         if (roles && roles.length > 0) {
            //             // 获取第一个角色
            //             const firstRole = roles[0];
            //             selectedRoleId = firstRole.id;
            //             selectedRoleName = firstRole.name;
            //             console.log(`已从会话中获取角色: ${selectedRoleName} (${selectedRoleId})`);
                        
            //             // 更新页面标题
            //             updatePageWithRoleName(selectedRoleName);
            //         }
            //     }).catch(error => {
            //         console.warn('获取会话角色失败:', error);
            //     });
                
                let title = ``;
                // 显示完整会话ID
                title += `(会话: ${params.sessionId}) `;
                // 如果有用户名，显示用户名
                if (params.userName) {
                    title += `用户: ${params.userName}`;
                }
                // 更新页面标题
                updatePageWithRoleName(`${params.userName}`);
                document.getElementById('session-title').innerText = title;
                console.log(`已加载会话: ${params.sessionId}, 用户: ${params.userName}`);

                // 尝试加载历史消息
                loadSessionMessages(params.userId);
            } else {
                console.warn('未提供会话ID，将使用临时会话 - 这可能导致某些功能不可用');

                // 添加警告消息到UI
                const warningElement = document.createElement('div');
                warningElement.className = 'message system';
                warningElement.innerHTML = `
                    <div class="message-content" style="color: #e65100; background-color: #fff3e0; padding: 10px; border-radius: 5px;">
                        <strong>⚠️ 警告：</strong> 未提供会话ID参数，正在使用临时会话模式。
                        <br><br>
                        某些功能可能不可用。建议通过正确的方式访问，如：
                        <br>
                        <code style="background: #f5f5f5; padding: 3px 5px;">/static/rag-chat.html?session_id=您的会话ID</code>
                    </div>
                `;
                messagesContainer.appendChild(warningElement);

                // 初始系统消息
                currentMessages.push({
                    role: 'system',
                    content: `你是一个知识渊博、乐于助人的助手。`
                });
            }

            // 添加事件监听器
            sendButton.addEventListener('click', sendMessage);
            stopButton.addEventListener('click', stopGeneration);
            clearButton.addEventListener('click', resetSessionLock);
            resetLockButton.addEventListener('click', resetSessionLock);

            // 添加输入框回车事件
            userInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // 加载会话历史消息
        async function loadSessionMessages(userId) {
            if (!currentSessionId || isLoadingHistory) return;

            isLoadingHistory = true;
            console.log('开始加载历史消息, 会话ID:', currentSessionId);
            
            // 确保有用户ID - 优先使用传入的参数，然后是全局变量，最后是默认值
            const effectiveUserId = userId || currentUserId || 'anonymous_user';
            console.log('加载历史消息使用用户ID:', effectiveUserId);

            // 创建加载中元素并添加唯一ID以便后续引用
            const loadingElementId = `loading-indicator-${Date.now()}`;
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message system';
            loadingElement.id = loadingElementId;
            loadingElement.innerHTML = '<div class="message-content">加载历史消息中...</div>';
            messagesContainer.appendChild(loadingElement);

            try {
                // 调用API获取会话详情
                // console.log(`请求会话详情: /api/memory/session/${currentSessionId}`);
                // const sessionResponse = await fetch(`/api/memory/session/${currentSessionId}`);

                // if (!sessionResponse.ok) {
                //     throw new Error(`获取会话详情失败: ${sessionResponse.status}`);
                // }

                // const sessionData = await sessionResponse.json();

                // if (!sessionData.success || !sessionData.exists) {
                //     console.warn('会话不存在或数据加载失败，将继续获取消息');
                // }

                // 获取短期记忆消息 - 使用正确的API端点
                console.log(`请求会话消息: /api/memory/session/${currentSessionId}/messages`);
                let messagesResponse = await fetch(`/api/memory/session/${currentSessionId}`);

                if (!messagesResponse.ok) {
                    console.warn(`获取会话消息失败，尝试备用端点: ${messagesResponse.status}`);
                    // 尝试备用API端点
                    const fallbackResponse = await fetch(`/api/memory/session/${currentSessionId}/messages`);
                    if (!fallbackResponse.ok) {
                        throw new Error(`所有消息API端点都失败: ${fallbackResponse.status}`);
                    }
                    messagesResponse = fallbackResponse;
                }
                
                const messagesData = await messagesResponse.json();
                processMessages(messagesData.messages || []);

                // 安全地移除加载消息
                safeRemoveElement(loadingElementId);

                // 滚动到底部
                scrollToBottom();

            } catch (error) {
                console.error('加载历史消息失败:', error);

                // 安全地移除加载消息
                safeRemoveElement(loadingElementId);

                // 显示错误消息
                const errorElement = document.createElement('div');
                errorElement.className = 'message system';
                errorElement.innerHTML = `<div class="message-content">加载历史消息失败: ${error.message}</div>`;
                messagesContainer.appendChild(errorElement);

                // 添加系统消息到当前会话
                currentMessages.push({
                    role: 'system',
                    content: `你是一个知识渊博、乐于助人的助手。`
                });

            } finally {
                isLoadingHistory = false;
            }
        }

        // 添加一个安全移除元素的辅助函数
        function safeRemoveElement(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.parentNode) {
                try {
                    element.parentNode.removeChild(element);
                    console.log(`成功移除元素: ${elementId}`);
                } catch (e) {
                    console.warn(`移除元素 ${elementId} 时出错:`, e);
                }
            } else {
                console.log(`元素 ${elementId} 不存在或已被移除`);
            }
        }

        // 处理历史消息数据
        function processMessages(messages) {
            // 清空消息容器
            messagesContainer.innerHTML = '';

            // 重置当前消息数组
            currentMessages = [];

            // 添加系统消息
            currentMessages.push({
                role: 'system',
                content: `你是一个知识渊博、乐于助人的助手。`
            });
            
            // 检查消息中是否有角色信息
            if (messages && messages.length > 0) {
                // 尝试从历史消息中找到助手角色名称
                for (const msg of messages) {
                    if (msg.role === 'assistant' && msg.assistant_name) {
                        selectedRoleName = msg.assistant_name;
                        console.log(`从历史消息中获取到角色名称: ${selectedRoleName}`);
                        break;
                    }
                    // 检查元数据中的角色ID
                    if (msg.metadata && msg.metadata.role_id) {
                        selectedRoleId = msg.metadata.role_id;
                        console.log(`从历史消息中获取到角色ID: ${selectedRoleId}`);
                    }
                }
            }

            // 如果没有消息，直接返回
            if (!messages || messages.length === 0) {
                return;
            }

            // 按时间排序消息（确保最老的消息先显示）
            messages.sort((a, b) => {
                const timeA = new Date(a.timestamp || a.created_at || 0);
                const timeB = new Date(b.timestamp || b.created_at || 0);
                return timeA - timeB;
            });

            // 遍历消息并添加到UI
            messages.forEach(msg => {
                // 确定角色
                let role = msg.role || (msg.is_user ? 'user' : 'assistant');

                // 获取发送者名称（如果有的话）
                let senderName = null;
                if (role === 'user') {
                    // 尝试从消息中获取用户名
                    senderName = msg.user_name || msg.sender || currentUserName;
                } else if (role === 'assistant') {
                    senderName = msg.assistant_name || selectedRoleName;
                }

                // 创建消息元素
                const messageElement = document.createElement('div');
                messageElement.className = `message ${role}`;

                // 添加发送者名称（如果不是系统消息）
                if (role !== 'system' && senderName) {
                    const senderElement = document.createElement('div');
                    senderElement.className = 'message-sender';
                    senderElement.textContent = senderName;
                    messageElement.appendChild(senderElement);
                }

                // 添加消息内容
                const contentElement = document.createElement('div');
                contentElement.className = 'message-content';

                if (role === 'assistant') {
                    contentElement.innerHTML = formatAssistantContent(msg.content);
                } else {
                    contentElement.textContent = msg.content;
                }

                messageElement.appendChild(contentElement);
                messagesContainer.appendChild(messageElement);

                // 添加到当前消息数组（用于API调用）
                if (role !== 'system') {
                    currentMessages.push({
                        role: role,
                        content: msg.content
                    });
                }
            });

            // 滚动到底部
            scrollToBottom();
        }

        // 重置会话锁
        async function resetSessionLock() {
            if (!currentSessionId) {
                console.warn('没有会话ID，无法重置锁');
                return false;
            }
            
            try {
                resetLockButton.disabled = true;
                resetLockButton.textContent = '重置中...';
                
                const response = await fetch('/api/llm/chatrag/reset-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        request_id: currentMessageId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`重置锁失败: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('重置会话锁成功:', result);
                
                // 显示成功提示
                showSystemMessage('会话锁已重置，可以继续发送消息');
                
                // 隐藏重置按钮
                resetLockButton.style.display = 'none';
                resetLockButton.disabled = false;
                resetLockButton.textContent = '重置会话锁';
                
                return true;
            } catch (error) {
                console.error('重置会话锁失败:', error);
                
                // 恢复按钮状态
                resetLockButton.disabled = false;
                resetLockButton.textContent = '重置会话锁';
                
                showSystemMessage(`重置会话锁失败: ${error.message}`);
                return false;
            }
        }
        
        // 显示系统消息
        function showSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `<div class="message-content">${message}</div>`;
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }

        // 修改发送消息函数，实现两阶段调用
        async function sendMessage() {
            const userMessage = userInput.value.trim();

            if (!userMessage || isWaitingForResponse) return;

            // 添加用户消息到UI
            addMessageToUI('user', userMessage);

            // 添加到消息历史
            currentMessages.push({
                role: 'user',
                content: userMessage
            });

            // 清空输入框并更新状态
            userInput.value = '';
            isWaitingForResponse = true;
            sendButton.disabled = true;

            try {
                // 创建助手响应框
                const assistantMessageElement = addMessageToUI('assistant', '思考中...', selectedRoleName);
                console.log('创建助手消息元素:', assistantMessageElement);

                // 第一阶段：角色选择
                console.log("开始第一阶段：角色选择");
                const roleResult = await selectRole(userMessage);

                if (!roleResult.success) {
                    // 角色选择失败，显示错误
                    updateAssistantMessage(assistantMessageElement, `角色选择失败: ${roleResult.error || '未知错误'}`);
                    isWaitingForResponse = false;
                    sendButton.disabled = false;
                    return;
                }

                // 更新UI显示角色信息
                if (roleResult.role_info) {
                    updateAssistantRoleInfo(assistantMessageElement, roleResult.role_info);
                }

                // 第二阶段：生成响应
                console.log("开始第二阶段：生成响应", roleResult);
                await generateResponse(roleResult, assistantMessageElement);

            } catch (error) {
                console.error('发送消息失败:', error);
                
                // 在UI中显示错误消息
                const errorElement = document.createElement('div');
                errorElement.className = 'message system';
                // 在UI中显示详细错误信息
                const contentElement = assistantMessageElement.querySelector('.message-content');
                if (contentElement) {
                    contentElement.innerHTML = `
                        <div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                            <strong>发送消息失败:</strong> ${error.message}
                            <br><br>
                            <details>
                                <summary>查看详细错误信息</summary>
                                <pre style="background: #f5f5f5; padding: 8px; overflow: auto;">${error.stack || '没有更多信息'}</pre>
                            </details>
                        </div>
                    `;
                    
                    // 如果错误看起来像是锁相关问题，添加重置选项
                    if (error.message.includes('423') || 
                        error.message.toLowerCase().includes('lock') || 
                        error.message.includes('会话') || 
                        error.message.includes('正在处理')) {
                        
                        contentElement.innerHTML += `
                            <div style="margin-top: 10px;">
                                可能是会话锁定问题，请尝试重置会话锁
                            </div>
                        `;
                        
                        // 显示重置按钮
                        resetLockButton.style.display = 'inline-block';
                    } else {
                        contentElement.innerHTML += `
                            <div style="margin-top: 8px;">请刷新页面或返回会话列表重试。</div>
                        `;
                    }
                }

                // 重置状态
                isWaitingForResponse = false;
                sendButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        // 停止生成
        async function stopGeneration() {
            if (!currentMessageId) {
                console.log('没有当前消息ID，无法停止生成');
                return;
            }

            try {
                console.log('停止生成消息:', currentMessageId);

                const requestData = {
                    message_id: currentMessageId
                };

                const response = await fetch('/api/llm/chatrag/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API错误: ${response.status}`);
                }

                // 禁用停止按钮
                stopButton.disabled = true;
            } catch (error) {
                console.error('停止生成失败:', error);
            }
        }

        // 添加消息到UI
        function addMessageToUI(role, content, senderName = null) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}`;
            
            // 添加发送者名称
            if (role !== 'system') {
                const senderElement = document.createElement('div');
                senderElement.className = 'message-sender';
                
                if (role === 'user') {
                    senderElement.textContent = currentUserName || '用户';
                } else {
                    senderElement.textContent = senderName || selectedRoleName || '助手';
                }
                
                messageElement.appendChild(senderElement);
            }
            
            // 添加消息内容
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            
            if (role === 'assistant') {
                contentElement.innerHTML = formatAssistantContent(content);
            } else {
                contentElement.textContent = content;
            }
            
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);
            
            // 滚动到底部
            scrollToBottom();
            
            return messageElement;
        }

        // 更新助手消息内容
        function updateAssistantMessage(element, content) {
            const contentElement = element.querySelector('.message-content');
            if (!contentElement) {
                console.error('找不到消息内容元素:', element);
                return;
            }

            console.log('更新消息内容:', content.substring(0, 50) + (content.length > 50 ? '...' : ''));
            contentElement.innerHTML = formatAssistantContent(content);

            // 滚动到底部
            scrollToBottom();
        }

        // 格式化助手内容（支持基本Markdown）
        function formatAssistantContent(content) {
            if (!content) return '';

            // 转义HTML
            let formatted = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // 简单的Markdown支持
            // 代码块 ```code```
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // 行内代码 `code`
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // 粗体 **text**
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 斜体 *text*
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 换行
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // 显示引用信息
        function showReferences(references, messageElement) {
            // 创建引用容器
            const referencesContainer = document.createElement('div');
            referencesContainer.className = 'references-container';

            // 添加标题
            const headerElement = document.createElement('div');
            headerElement.className = 'references-header';
            headerElement.textContent = '参考资料';
            referencesContainer.appendChild(headerElement);

            // 添加引用列表
            references.forEach((ref, index) => {
                const refElement = document.createElement('div');
                refElement.className = 'reference-item';

                // 添加标题
                const titleElement = document.createElement('div');
                titleElement.className = 'reference-title';
                titleElement.textContent = `[${index + 1}] ${ref.title || '未知来源'}`;
                refElement.appendChild(titleElement);

                // 添加内容
                const contentElement = document.createElement('div');
                contentElement.className = 'reference-content';
                contentElement.textContent = ref.content || ref.text || '';
                refElement.appendChild(contentElement);

                referencesContainer.appendChild(refElement);
            });

            // 添加到消息元素
            messageElement.appendChild(referencesContainer);

            // 滚动到底部
            scrollToBottom();
        }

        // 滚动到底部
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 第一阶段：角色选择
        async function selectRole(userMessage) {
            try {
                const requestData = {
                    messages: currentMessages,
                    session_id: currentSessionId,
                    user_id: currentUserId,
                    auto_role_match: document.getElementById('auto-role-match')?.checked || false,
                    provider: null,
                    model_name: null,
                    api_key: null
                };

                console.log('发送角色选择请求:', JSON.stringify({ request_data: requestData }, null, 2));
                
                // 使用正式的角色选择路由
                const response = await fetch('/api/llm/chatrag/role-select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ request_data: requestData })
                });

                if (!response.ok) {
                    if (response.status === 423) {
                        throw new Error('会话锁定，请重置会话锁或稍后再试');
                    }
                    throw new Error(`角色选择请求失败: ${response.status}`);
                }

                const result = await response.json();
                console.log('角色选择结果:', result);

                if (result.role_match && result.role_match.success && result.role_match.role) {
                    // 更新全局变量
                    updateSelectedRole(
                        result.role_match.role.id,
                        result.role_match.role.name
                    );

                    return {
                        success: true,
                        request_id: result.request_id,
                        role_id: result.role_match.role.id,
                        role_info: result.role_match.role,
                        match_reason: result.role_match.match_reason,
                        provider: result.provider,
                        model_name: result.model_name,
                        api_key: result.api_key
                    };
                }

                // 如果没有角色匹配成功，但请求成功了，仍然返回成功状态但不带角色ID
                return {
                    success: true,
                    request_id: result.request_id,
                    error: result.role_match?.error || "未找到合适角色"
                };
            } catch (error) {
                console.error('角色选择失败:', error);
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }

        // 第二阶段：生成响应
        async function generateResponse(roleResult, assistantMessageElement) {
            try {
                const requestData = {
                    messages: currentMessages,
                    session_id: currentSessionId,
                    user_id: currentUserId,
                    role_id: roleResult.role_id,
                    request_id: roleResult.request_id,
                    stream: true,
                    provider: roleResult.provider,
                    model_name: roleResult.model_name,
                    api_key: roleResult.api_key
                };

                console.log('发送响应生成请求:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch('/api/llm/chatrag/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    if (response.status === 423) {
                        const errorData = await response.json();
                        console.warn('会话被锁定:', errorData);
                        
                        // 显示错误信息
                        const contentElement = assistantMessageElement.querySelector('.message-content');
                        if (contentElement) {
                            contentElement.innerHTML = `
                                <div style="color: #FF6F00; padding: 10px; background-color: #FFF3E0; border-radius: 5px; margin-bottom: 10px;">
                                    <strong>会话锁定错误:</strong> ${errorData.error || '会话当前正在处理另一个请求，请稍后再试'}
                                </div>
                                <div>正在尝试自动重置会话锁...</div>
                            `;
                        }
                        
                        // 尝试重置锁
                        const resetResult = await resetSessionLock();
                        
                        if (resetResult) {
                            if (contentElement) {
                                contentElement.innerHTML += `
                                    <div style="color: #388E3C; padding: 10px; background-color: #E8F5E9; border-radius: 5px; margin-top: 10px;">
                                        会话锁已重置，请重新发送消息
                                    </div>
                                `;
                            }
                        } else {
                            // 显示手动重置按钮
                            resetLockButton.style.display = 'inline-block';
                            
                            if (contentElement) {
                                contentElement.innerHTML += `
                                    <div style="margin-top: 10px;">
                                        自动重置失败，请点击"重置会话锁"按钮手动重置，或刷新页面重试
                                    </div>
                                `;
                            }
                        }
                        
                        // 重置状态
                        isWaitingForResponse = false;
                        sendButton.disabled = false;
                        stopButton.disabled = true;
                        return;
                    }
                    
                    throw new Error(`响应生成请求失败: ${response.status}`);
                }

                // 检查响应格式
                const contentType = response.headers.get('Content-Type') || '';
                const isStreamResponse = contentType.includes('text/event-stream');
                console.log('是否为流式响应:', isStreamResponse);
                
                if (isStreamResponse) {
                    // 处理流式响应
                    await processStreamResponse(response, assistantMessageElement);
                } else {
                    // 处理非流式响应
                    const jsonData = await response.json();
                    console.log('非流式响应内容:', jsonData);
                    
                    // 提取内容
                    let responseContent = null;
                    
                    if (jsonData.choices && jsonData.choices.length > 0) {
                        if (jsonData.choices[0].message && jsonData.choices[0].message.content) {
                            responseContent = jsonData.choices[0].message.content;
                        }
                    } else if (jsonData.content) {
                        responseContent = jsonData.content;
                    }
                    
                    if (responseContent) {
                        updateAssistantMessage(assistantMessageElement, responseContent);
                        
                        // 添加到消息历史
                        currentMessages.push({
                            role: 'assistant',
                            content: responseContent
                        });
                    } else {
                        updateAssistantMessage(assistantMessageElement, '无法解析服务器响应');
                    }
                }
                
            } catch (error) {
                console.error('生成响应失败:', error);
                
                // 显示错误消息
                const contentElement = assistantMessageElement.querySelector('.message-content');
                if (contentElement) {
                    contentElement.innerHTML = `
                        <div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                            <strong>生成响应失败:</strong> ${error.message}
                        </div>
                    `;
                }
            } finally {
                // 重置状态
                isWaitingForResponse = false;
                sendButton.disabled = false;
                stopButton.disabled = true;
                
                // 滚动到底部
                scrollToBottom();
            }
        }
        
        // 处理流式响应
        async function processStreamResponse(response, assistantMessageElement) {
            let reader = null;
            let responseText = '';
            
            try {
                // 启用停止按钮
                stopButton.disabled = false;
                currentMessageId = null;
                
                try {
                    // 安全获取reader
                    reader = response.body.getReader();
                    window.currentReader = reader;
                } catch (readerError) {
                    console.error('获取流读取器失败:', readerError);
                    throw readerError;
                }
                
                const decoder = new TextDecoder();
                
                // 处理SSE流
                try {
                    console.log('开始处理响应流');
                    while (true) {
                        let readResult;
                        try {
                            readResult = await reader.read();
                        } catch (readError) {
                            console.error('读取流失败:', readError);
                            break;
                        }
                        
                        const { value, done } = readResult;
                        
                        if (done) {
                            console.log('响应流结束 - done标志');
                            break;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        console.log('接收到数据块:', chunk.length, '字节');
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            // 忽略空行或只包含HTTP头信息的行
                            if (!line.trim() || line.trim().startsWith(':') || line.includes('keep-alive')) {
                                continue;
                            }
                            
                            if (line.startsWith('data: ') && line.length > 6) {
                                const data = line.substring(6).trim();
                                console.log('处理SSE数据行:', data.substring(0, 50) + (data.length > 50 ? '...' : ''));

                                // 检查是否为结束标记
                                if (data === '[DONE]') {
                                    isWaitingForResponse = false;
                                    sendButton.disabled = false;
                                    stopButton.disabled = true;
                                    break;
                                }

                                try {
                                    // 解析 JSON 数据
                                    let parsedData = JSON.parse(data);
                                    
                                    // 检查是否有错误
                                    if (parsedData.error) {
                                        console.error('API错误:', parsedData.error);
                                        const contentElement = assistantMessageElement.querySelector('.message-content');
                                        if (contentElement) {
                                            const errorMsg = `<div style="color: red; padding: 10px; background-color: #ffeeee; border-radius: 5px;">
                                                <strong>错误:</strong> ${parsedData.error}
                                            </div>`;
                                            contentElement.innerHTML += errorMsg;
                                        }
                                        continue;
                                    }
                                    
                                    // 处理消息ID
                                    if (parsedData.message_id) {
                                        console.log('收到消息ID:', parsedData.message_id);
                                        currentMessageId = parsedData.message_id;
                                        stopButton.disabled = false;
                                        continue;
                                    }
                                    
                                    // 处理角色匹配结果
                                    if (parsedData.role_match) {
                                        console.log('角色匹配结果:', parsedData.role_match);
                                        const roleMatch = parsedData.role_match;
                                        
                                        if (roleMatch.success && roleMatch.role) {
                                            // 更新全局变量，保存匹配的角色名称
                                            if (roleMatch.role.name) {
                                                selectedRoleName = roleMatch.role.name;
                                                console.log('更新全局角色名称为:', selectedRoleName);
                                                
                                                // 更新页面标题显示角色名
                                                updatePageWithRoleName(selectedRoleName);
                                            }
                                            // 调用函数处理角色信息
                                            updateAssistantRoleInfo(assistantMessageElement, roleMatch.role);
                                        }
                                        continue;
                                    }
                                    
                                    // 处理常规SSE流式响应 (api/llm/chat格式)
                                    if (parsedData.event_type === 'content') {
                                        if (parsedData.text) {
                                            responseText += parsedData.text;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                        }
                                    }
                                    // 处理RAG格式响应 (api/llm/chatrag格式)
                                    else if (parsedData.choices && Array.isArray(parsedData.choices)) {
                                        // 处理不同类型的RAG响应
                                        if (parsedData.choices[0].delta && parsedData.choices[0].delta.content) {
                                            // 流式增量格式
                                            responseText += parsedData.choices[0].delta.content;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                        }
                                        else if (parsedData.choices[0].message && parsedData.choices[0].message.content) {
                                            // 完整消息格式
                                            responseText = parsedData.choices[0].message.content;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                            
                                            // 这是完整响应，可以退出处理循环
                                            isWaitingForResponse = false;
                                            sendButton.disabled = false;
                                            stopButton.disabled = true;
                                            break;
                                        }
                                        else if (parsedData.choices[0].delta && parsedData.choices[0].delta.role === 'assistant') {
                                            // 角色声明，忽略但记录
                                            console.log('收到角色声明:', parsedData.choices[0].delta.role);
                                        }
                                        else if (parsedData.choices[0].finish_reason) {
                                            // 结束标记
                                            console.log('收到结束标记:', parsedData.choices[0].finish_reason);
                                            isWaitingForResponse = false;
                                            sendButton.disabled = false;
                                            stopButton.disabled = true;
                                            break;
                                        }
                                    }
                                    // 处理引用信息
                                    else if (parsedData.event_type === 'references' || 
                                          (parsedData.type === 'references' && parsedData.references)) {
                                        references = parsedData.references;
                                        
                                        // 添加引用信息到UI
                                        if (references && references.length > 0) {
                                            showReferences(references, assistantMessageElement);
                                        }
                                    }
                                    // 处理新格式的流式响应 (role, content, status格式)
                                    else if (parsedData.role === 'assistant' && parsedData.content !== undefined) {
                                        console.log('处理新格式SSE:', parsedData.status, parsedData.content.length, '字符');
                                        
                                        // 检查是否为流式传输或完成
                                        if (parsedData.status === 'streaming') {
                                            // 流式累积内容
                                            responseText += parsedData.content;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                        } 
                                        else if (parsedData.status === 'complete') {
                                            // 完整内容，可能包含之前的内容，所以直接赋值而不是累加
                                            responseText = parsedData.content;
                                            updateAssistantMessage(assistantMessageElement, responseText);
                                            
                                            // 这是完整响应，可以退出处理循环
                                            isWaitingForResponse = false;
                                            sendButton.disabled = false;
                                            stopButton.disabled = true;
                                        }
                                    }
                                } catch (e) {
                                    console.warn('解析响应数据失败:', e, data);
                                }
                            }
                        }
                    }

                    // 添加到消息历史
                    if (responseText) {
                        currentMessages.push({
                            role: 'assistant',
                            content: responseText
                        });
                    }
                } catch (e) {
                    console.error('解析流式响应失败:', e);
                    throw e;
                } finally {
                    // 在finally语句中确保释放reader
                    try {
                        if (reader) {
                            try {
                                // 尝试取消读取
                                reader.cancel().catch(e => console.warn('取消reader失败:', e));
                                // 清除全局引用
                                if (window.currentReader === reader) {
                                    window.currentReader = null;
                                }
                            } catch (cancelError) {
                                console.warn('取消reader失败:', cancelError);
                            }
                        }
                    } catch (e) {
                        console.warn('关闭reader失败:', e);
                    }
                }
            } catch (error) {
                console.error('处理流式响应失败:', error);
                throw error;
            }
        }

        // 更新辅助函数
        
        // 添加处理角色信息的函数
        function updateAssistantRoleInfo(messageElement, roleInfo) {
            if (!messageElement || !roleInfo) return;
            
            console.log('更新角色信息:', roleInfo);
            
            // 更新全局变量
            if (roleInfo.name) {
                selectedRoleName = roleInfo.name;
            }
            
            // 更新角色名称
            const senderElement = messageElement.querySelector('.message-sender');
            if (senderElement) {
                const roleName = roleInfo.name || selectedRoleName || '助手';
                senderElement.textContent = roleName;
            } else {
                // 如果没有发送者元素，创建一个
                const newSenderElement = document.createElement('div');
                newSenderElement.className = 'message-sender';
                newSenderElement.textContent = roleInfo.name || selectedRoleName || '助手';
                messageElement.insertBefore(newSenderElement, messageElement.firstChild);
            }
            
            // 检查是否已经有匹配原因元素
            const existingReasonElement = messageElement.querySelector('.match-reason');
            
            // 如果有匹配原因且尚未显示，添加它
            if (roleInfo.match_reason && !existingReasonElement) {
                const contentElement = messageElement.querySelector('.message-content');
                if (contentElement) {
                    const matchReasonElement = document.createElement('div');
                    matchReasonElement.className = 'match-reason';
                    matchReasonElement.style.fontSize = '0.85em';
                    matchReasonElement.style.color = '#666';
                    matchReasonElement.style.fontStyle = 'italic';
                    matchReasonElement.style.marginBottom = '5px';
                    matchReasonElement.innerHTML = `匹配原因: ${roleInfo.match_reason}`;
                    messageElement.insertBefore(matchReasonElement, contentElement);
                }
            }
        }

        // 处理角色匹配相关的函数
        function updateSelectedRole(roleId, roleName) {
            selectedRoleId = roleId;
            if (roleName) {
                selectedRoleName = roleName;
                console.log(`已更新选中角色: ${roleName} (${roleId})`);
                // 更新页面标题或其他UI元素，显示已选择的角色
                const sessionTitle = document.getElementById('session-title');
                if (sessionTitle) {
                    sessionTitle.textContent = `会话 - ${roleName}`;
                }
            }
        }

        // 使用角色名称更新页面UI元素
        function updatePageWithRoleName(roleName) {
            if (!roleName) return;
            
            console.log(`更新页面显示角色名: ${roleName}`);
            
            // 更新页面标题
            const sessionTitle = document.getElementById('session-title');
            if (sessionTitle) {
                // 保留会话ID部分
                let existingTitle = sessionTitle.textContent || '';
                if (existingTitle.includes('(会话:')) {
                    // 提取会话ID部分
                    const sessionPart = existingTitle.match(/\(会话:.*?\)/);
                    if (sessionPart) {
                        sessionTitle.textContent = `${sessionPart[0]} 角色: ${roleName}`;
                    } else {
                        sessionTitle.textContent = `${existingTitle} - ${roleName}`;
                    }
                } else {
                    sessionTitle.textContent = `${existingTitle} - ${roleName}`;
                }
            }
            
            // 更新页面顶部可能显示的角色名
            document.querySelectorAll('.response-sender, .ai-name').forEach(elem => {
                if (elem.textContent.includes('智能助手') || elem.textContent === '助手') {
                    elem.textContent = roleName;
                }
            });
            
            // 添加一个辅助元素在页面头部显示角色名
            const headerElem = document.querySelector('header');
            if (headerElem) {
                if (!document.querySelector('.current-role-display')) {
                    const roleDisplay = document.createElement('div');
                    roleDisplay.className = 'current-role-display';
                    roleDisplay.style.fontSize = '0.85rem';
                    roleDisplay.style.color = '#555';
                    roleDisplay.style.marginTop = '5px';
                    roleDisplay.innerHTML = `当前角色: <span class="current-role-name">${roleName}</span>`;
                    headerElem.appendChild(roleDisplay);
                } else {
                    const roleNameElem = document.querySelector('.current-role-name');
                    if (roleNameElem) {
                        roleNameElem.textContent = roleName;
                    }
                }
            }
            
            // 更新现有的所有助手消息的发送者名称
            document.querySelectorAll('.message.assistant .message-sender').forEach(sender => {
                sender.textContent = roleName;
            });
            
            console.log(`页面UI已更新为角色名称: ${roleName}`);
        }

        // 从服务器获取会话角色信息
        // async function fetchSessionRoles(sessionId) {
        //     try {
        //         // 尝试从会话服务获取角色信息
        //         console.log(`获取会话 ${sessionId} 的角色信息`);
        //         const response = await fetch(`/api/sessions/${sessionId}/roles`);
                
        //         if (!response.ok) {
        //             console.warn(`获取会话角色失败: ${response.status}`);
        //             return null;
        //         }
                
        //         const rolesData = await response.json();
        //         console.log('获取到会话角色信息:', rolesData);
                
        //         return rolesData.map(role => ({
        //             id: role._id || role.id,
        //             name: role.name,
        //             description: role.description
        //         }));
                
        //     } catch (error) {
        //         console.error('获取会话角色出错:', error);
        //         return null;
        //     }
        // }
    </script>
</body>

</html>