<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流式API演示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            height: 500px;
            overflow-y: auto;
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
        }
        .user-message {
            background-color: #d1e7ff;
            margin-left: auto;
            text-align: right;
        }
        .assistant-message {
            background-color: #f0f0f0;
            margin-right: auto;
        }
        .message-container {
            display: flex;
            margin-bottom: 15px;
        }
        #errorContainer {
            display: none;
            margin-top: 15px;
        }
        .typing-indicator {
            display: inline-block;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 10px;
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
        }
        .typing-indicator:after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        #phase2Container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        #feedbackBtns {
            margin-top: 10px;
        }
        .role-info {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e2f2ff;
            border-radius: 5px;
            font-size: 14px;
            border-left: 3px solid #0d6efd;
        }
        .info-panel {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .improving-indicator {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeeba;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">流式API演示</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="info-panel">
                    <h4>当前会话信息</h4>
                    <div id="sessionInfo">未创建会话</div>
                </div>
                
                <div id="chatContainer" class="chat-container">
                    <!-- 聊天消息将在这里动态添加 -->
                </div>
                
                <div id="typingIndicator" class="typing-indicator" style="display: none;">AI正在思考</div>
                
                <div class="mb-3">
                    <label for="userInput" class="form-label">发送消息</label>
                    <textarea id="userInput" class="form-control" rows="3" placeholder="输入您的问题..."></textarea>
                </div>
                
                <button id="sendBtn" class="btn btn-primary">发送</button>
                
                <div id="errorContainer" class="alert alert-danger mt-3">
                    <strong>错误：</strong> <span id="errorMessage"></span>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="info-panel">
                    <h4>角色信息</h4>
                    <div id="roleInfo"></div>
                </div>
                
                <button id="createSessionBtn" class="btn btn-outline-primary w-100 mb-3">创建会话</button>
                <button id="clearChatBtn" class="btn btn-outline-secondary w-100">清空聊天记录</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatContainer = document.getElementById('chatContainer');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const sessionInfo = document.getElementById('sessionInfo');
            const roleInfo = document.getElementById('roleInfo');
            const typingIndicator = document.getElementById('typingIndicator');
            const createSessionBtn = document.getElementById('createSessionBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');
            
            // 状态变量
            let currentSessionId = null;
            let lastMessageId = null;
            let currentEventSource = null;
            
            // 解析URL参数函数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                
                for (const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                
                return params;
            }
            
            // 检查并处理URL参数
            function processUrlParams() {
                const params = getUrlParams();
                console.log("URL参数:", params);
                
                // 检查displayParams参数是否为true
                if (params.displayParams === "true" && params.session_id && params.userName && params.userId) {
                    // 设置会话ID
                    currentSessionId = params.session_id;
                    
                    // 更新会话信息显示
                    sessionInfo.innerHTML = `
                        <strong>会话ID:</strong> ${params.session_id}<br>
                        <strong>用户:</strong> ${params.userName}<br>
                        <strong>用户ID:</strong> ${params.userId}<br>
                        <strong>来源:</strong> URL参数
                    `;
                    
                    // 禁用创建会话按钮
                    createSessionBtn.textContent = "已从URL加载会话";
                    createSessionBtn.disabled = true;
                    
                    // 添加欢迎消息
                    addSystemMessage(`会话已从URL加载，会话ID: ${params.session_id.substring(0, 8)}...`);
                    
                    // 获取会话的角色信息
                    fetchSessionRoles(params.session_id);
                    
                    // 返回true表示已处理URL参数
                    return true;
                }
                
                // 返回false表示未处理URL参数
                return false;
            }
            
            // 获取会话的角色信息
            async function fetchSessionRoles(sessionId) {
                try {
                    // 显示加载状态
                    roleInfo.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>正在加载角色信息...</p></div>';
                    
                    // 获取会话详情
                    const response = await fetch(`/api/custom-sessions/${sessionId}`);
                    if (!response.ok) {
                        throw new Error('获取会话详情失败');
                    }
                    
                    const sessionData = await response.json();
                    console.log('会话详情:', sessionData);
                    
                    // 检查是否有角色数据
                    if (sessionData.roles && sessionData.roles.length > 0) {
                        // 更新角色信息显示
                        roleInfo.innerHTML = sessionData.roles.map(role => `
                            <div class="role-info">
                                <strong>${role.role_name || '未命名角色'}</strong><br>
                                <small class="text-muted">角色ID: ${role.role_id}</small><br>
                                ${role.system_prompt ? 
                                    `<div class="small mt-2" style="max-height: 150px; overflow-y: auto; background-color: #f8f9fa; padding: 8px; border-radius: 4px; font-family: monospace;">${role.system_prompt}</div>` 
                                    : '<small class="text-muted">无系统提示词</small>'}
                            </div>
                        `).join('');
                    } else {
                        // 如果没有找到角色信息
                        roleInfo.innerHTML = '<div class="alert alert-warning">未找到角色信息</div>';
                        
                        // 尝试获取角色列表作为备选方案
                        fetchRoleList();
                    }
                } catch (error) {
                    console.error('获取会话角色信息失败:', error);
                    roleInfo.innerHTML = `<div class="alert alert-danger">获取角色信息失败: ${error.message}</div>`;
                    
                    // 尝试获取角色列表作为备选方案
                    fetchRoleList();
                }
            }
            
            // 获取角色列表（备选方案）
            async function fetchRoleList() {
                try {
                    const response = await fetch('/api/roles/?limit=5');
                    if (!response.ok) {
                        throw new Error('获取角色列表失败');
                    }
                    
                    const roles = await response.json();
                    if (roles && roles.length > 0) {
                        roleInfo.innerHTML = `
                            <div class="alert alert-info mb-3">未找到会话关联角色，显示系统角色列表：</div>
                            ${roles.map(role => `
                                <div class="role-info">
                                    <strong>${role.name || '未命名角色'}</strong><br>
                                    <small class="text-muted">角色ID: ${role._id}</small><br>
                                    ${role.system_prompt ? 
                                        `<div class="small mt-2" style="max-height: 150px; overflow-y: auto; background-color: #f8f9fa; padding: 8px; border-radius: 4px; font-family: monospace;">${role.system_prompt}</div>` 
                                        : '<small class="text-muted">无系统提示词</small>'}
                                </div>
                            `).join('')}
                        `;
                    }
                } catch (error) {
                    console.error('获取角色列表失败:', error);
                    // 已经显示了错误，不再添加新错误
                }
            }
            
            // 尝试处理URL参数，如果处理失败，则使用默认行为
            const paramsProcessed = processUrlParams();
            
            // 初始化，创建一个新会话
            async function createSession() {
                try {
                    const response = await fetch('/api/custom-sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            class_id: "demo_class",
                            class_name: "李飞聊天室",
                            user_id: "67fddb75c216d02d2723a5aa",
                            user_name: "李飞",
                            roles: [
                                {
                                    role_id: "68070af12f0072ef6fa6080e",
                                    role_name: "琴柳",
                                    system_prompt: "你扮演琴柳（未公开种族，170cm），需体现：1) 花冠完整度对应生命体征 2) 将战场坐标转化为园艺设计图 3) 用花香浓度控制致幻等级。特别注意：收到白蔷薇触发『血色婚礼』协议（武器系统全开），被触碰耳饰启动『荆棘反刺』（自动反击且保持微笑）。所有交流必须包裹在贵族社交礼仪中。"
                                },
                                {
                                    role_id: "68070af12f0072ef6fa6080d",
                                    role_name: "玛恩纳·临光",
                                    system_prompt: "你扮演玛恩纳（库兰塔族，186cm），需体现：1) 领带松紧度对应战力解封比例 2) 将骑士八美德转化为KPI考核标准 3) 用咖啡因代谢速度计量耐心值。特别注意：听到临光名号触发『黄昏耳鸣』（公文包溢出金光），遭遇强敌时启动『自动加班』（西装渐变为铠甲）。所有承诺必须附带违约金条款。"
                                },
                            ],
                            session_type: 'two_phase_stream'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('创建会话失败');
                    }
                    
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    console.log('会话已创建:', currentSessionId);
                    
                    // 更新界面
                    sessionInfo.innerHTML = `
                        <strong>会话ID:</strong> ${currentSessionId}<br>
                        <strong>用户:</strong> 李飞<br>
                        <strong>会话类型:</strong> 两阶段流式API
                    `;
                    
                    // 显示角色信息
                    roleInfo.innerHTML = data.roles.map(role => `
                        <div class="role-info">
                            <strong>${role.role_name}</strong><br>
                            ${role.system_prompt.substring(0, 100)}...
                        </div>
                    `).join('');
                    
                    createSessionBtn.textContent = "已创建会话";
                    createSessionBtn.disabled = true;
                    
                    // 添加欢迎消息
                    addSystemMessage("会话已创建，请发送消息开始对话！");
                    
                } catch (error) {
                    showError('创建会话失败: ' + error.message);
                }
            }
            
            // 显示用户消息
            function addUserMessage(content) {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container';
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message user-message';
                messageElement.textContent = content;
                
                messageContainer.appendChild(messageElement);
                chatContainer.appendChild(messageContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 显示AI消息
            function addAssistantMessage(content, roleRef = null) {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container';
                
                // 如果有角色信息，添加角色标签
                if (roleRef) {
                    const roleLabel = document.createElement('small');
                    roleLabel.style.marginRight = '10px';
                    roleLabel.style.color = '#666';
                    roleLabel.textContent = `${roleRef}: `;
                    messageContainer.appendChild(roleLabel);
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message assistant-message';
                messageElement.textContent = content;
                
                messageContainer.appendChild(messageElement);
                chatContainer.appendChild(messageContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                return messageElement;
            }
            
            // 显示系统消息
            function addSystemMessage(content) {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'text-center my-3';
                
                const messageElement = document.createElement('span');
                messageElement.className = 'badge bg-secondary';
                messageElement.textContent = content;
                
                messageContainer.appendChild(messageElement);
                chatContainer.appendChild(messageContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 显示错误
            function showError(message) {
                errorMessage.textContent = message;
                errorContainer.style.display = 'block';
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 5000);
            }
            
            // 发送用户消息
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                if (!currentSessionId) {
                    await createSession();
                }
                
                addUserMessage(message);
                userInput.value = '';
                
                // 显示正在输入指示器
                typingIndicator.style.display = 'inline-block';
                sendBtn.disabled = true;
                
                // 关闭之前的EventSource连接
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }
                
                // 创建消息容器，后续会更新内容
                const messagePlaceholder = addAssistantMessage("", "AI");
                
                // 创建角色信息容器
                const roleInfoElement = document.createElement('div');
                roleInfoElement.className = 'role-info';
                roleInfoElement.style.display = 'none';
                chatContainer.appendChild(roleInfoElement);
                
                try {
                    // 使用EventSource接收流式响应
                    const url = `/api/two-phase-stream/generate?session_id=${encodeURIComponent(currentSessionId)}&message=${encodeURIComponent(message)}`;
                    const eventSource = new EventSource(url);
                    currentEventSource = eventSource;
                    
                    // 存储流式响应的内容
                    let responseText = '';
                    
                    eventSource.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('接收到事件:', data);
                            
                            // 处理匹配信息
                            if (data.type === 'match_info') {
                                lastMessageId = data.message_id;
                                roleInfoElement.style.display = 'block';
                                roleInfoElement.innerHTML = `
                                    <strong>选中角色:</strong> ${data.selected_role}<br>
                                    <strong>匹配分数:</strong> ${(data.match_score * 100).toFixed(1)}%<br>
                                    <strong>匹配原因:</strong> ${data.match_reason}
                                `;
                                messagePlaceholder.parentElement.querySelector('small').textContent = `${data.selected_role}: `;
                            }
                            
                            // 处理内容片段
                            else if (data.type === 'content') {
                                responseText += data.content;
                                messagePlaceholder.textContent = responseText;
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                            
                            // 处理完成信号
                            else if (data.type === 'complete') {
                                // 关闭连接
                                eventSource.close();
                                currentEventSource = null;
                                
                                // 隐藏正在输入指示器
                                typingIndicator.style.display = 'none';
                                sendBtn.disabled = false;
                            }
                            
                            // 处理错误
                            else if (data.type === 'error') {
                                showError('生成响应时出错: ' + data.message);
                                eventSource.close();
                                currentEventSource = null;
                                typingIndicator.style.display = 'none';
                                sendBtn.disabled = false;
                            }
                        } catch (e) {
                            console.error('解析事件数据时出错:', e);
                        }
                    };
                    
                    eventSource.onerror = function(error) {
                        console.error('EventSource错误:', error);
                        eventSource.close();
                        currentEventSource = null;
                        typingIndicator.style.display = 'none';
                        sendBtn.disabled = false;
                        
                        if (responseText.length === 0) {
                            showError('连接中断或请求失败');
                        }
                    };
                    
                } catch (error) {
                    showError('发送消息失败: ' + error.message);
                    typingIndicator.style.display = 'none';
                    sendBtn.disabled = false;
                }
            }
            
            // 清空聊天记录
            function clearChat() {
                chatContainer.innerHTML = '';
                lastMessageId = null;
                
                // 如果创建了会话，添加重置消息
                if (currentSessionId) {
                    addSystemMessage("聊天记录已清空");
                }
            }
            
            // 事件监听
            sendBtn.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            createSessionBtn.addEventListener('click', createSession);
            clearChatBtn.addEventListener('click', clearChat);
        });
    </script>
</body>
</html> 